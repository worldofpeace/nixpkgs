From 8e9798aeed50c5e8b8e80da5bf19db4c6ac5e85f Mon Sep 17 00:00:00 2001
Message-Id: <8e9798aeed50c5e8b8e80da5bf19db4c6ac5e85f.1605134428.git-series.worldofpeace@protonmail.ch>
From: WORLDofPEACE <worldofpeace@protonmail.ch>
Date: Sat, 19 Oct 2019 13:26:05 +0200
Subject: [PATCH 1/4] drop inheritable

From: Tor Hedin Br√∏nner <torhedinbronner@gmail.com>

Adapted from https://gitlab.gnome.org/GNOME/mutter/commit/c53c47ae123b03cc66044d2b846342123ecb3a01

We only want to drop inheritable though, to prevent the ambient set leaking further than gnome-shell.
---
 config.h.meson    |  3 +++
 meson.build       |  5 +++++
 meson_options.txt |  6 ++++++
 src/core/main.c   | 10 ++++++++++
 src/meson.build   |  1 +
 5 files changed, 25 insertions(+)

diff --git a/config.h.meson b/config.h.meson
index 0edff4d..a9cc308 100644
--- a/config.h.meson
+++ b/config.h.meson
@@ -58,6 +58,9 @@
 /* Xwayland applications allowed to issue keyboard grabs */
 #mesondefine XWAYLAND_GRAB_DEFAULT_ACCESS_RULES
 
+/* Defined if libcap-ng is available */
+#mesondefine HAVE_LIBCAPNG
+
 /* XKB base prefix */
 #mesondefine XKB_BASE
 
diff --git a/meson.build b/meson.build
index 9b88b5b..8de856e 100644
--- a/meson.build
+++ b/meson.build
@@ -36,6 +36,7 @@ libstartup_notification_req = '>= 0.7'
 libcanberra_req = '>= 0.26'
 libwacom_req = '>= 0.13'
 atk_req = '>= 2.5.3'
+libcapng_req = '>= 0.7.9'
 
 # optional version requirements
 udev_req = '>= 228'
@@ -131,6 +132,7 @@ ice_dep = dependency('ice')
 atk_dep = dependency('atk', version: atk_req)
 libcanberra_dep = dependency('libcanberra', version: libcanberra_req)
 dbus_dep = dependency('dbus-1')
+libcapng_dep = dependency('libcap-ng', required: get_option('libcapng'))
 
 # For now always require X11 support
 have_x11 = true
@@ -263,6 +265,7 @@ have_core_tests = false
 have_cogl_tests = false
 have_clutter_tests = false
 have_installed_tests = false
+have_libcapng = libcapng_dep.found()
 
 if have_tests
   have_core_tests = get_option('core_tests')
@@ -368,6 +371,7 @@ cdata.set('HAVE_LIBWACOM', have_libwacom)
 cdata.set('HAVE_SM', have_sm)
 cdata.set('HAVE_STARTUP_NOTIFICATION', have_startup_notification)
 cdata.set('HAVE_INTROSPECTION', have_introspection)
+cdata.set('HAVE_LIBCAPNG', have_libcapng)
 cdata.set('HAVE_PROFILER', have_profiler)
 
 xkb_base = xkeyboard_config_dep.get_pkgconfig_variable('xkb_base')
@@ -465,6 +469,7 @@ output = [
   '        Introspection............ ' + have_introspection.to_string(),
   '        Profiler................. ' + have_profiler.to_string(),
   '        Xwayland initfd.......... ' + have_xwayland_initfd.to_string(),
+  '        libcap-ng................ ' + have_libcapng.to_string(),
   '',
   '    Tests:',
   '',
diff --git a/meson_options.txt b/meson_options.txt
index 655ef43..d88c5ab 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -1,3 +1,9 @@
+option('libcapng',
+  type: 'feature',
+  value: 'auto',
+  description: 'Enable libcap-ng support'
+)
+
 option('opengl',
   type: 'boolean',
   value: true,
diff --git a/src/core/main.c b/src/core/main.c
index 16ab6e8..b9eeb64 100644
--- a/src/core/main.c
+++ b/src/core/main.c
@@ -66,6 +66,10 @@
 #include <girepository.h>
 #endif
 
+#ifdef HAVE_LIBCAPNG
+#include <cap-ng.h>
+#endif
+
 #if defined(HAVE_NATIVE_BACKEND) && defined(HAVE_WAYLAND)
 #include <systemd/sd-login.h>
 #endif /* HAVE_WAYLAND && HAVE_NATIVE_BACKEND */
@@ -660,6 +664,12 @@ meta_run (void)
   if (!meta_display_open ())
     meta_exit (META_EXIT_ERROR);
 
+#ifdef HAVE_LIBCAPNG
+  capng_clear(CAPNG_SELECT_BOTH);
+  capng_update(CAPNG_ADD, CAPNG_EFFECTIVE|CAPNG_PERMITTED, CAP_SYS_NICE);
+  capng_apply(CAPNG_SELECT_BOTH);
+#endif
+
   g_main_loop_run (meta_main_loop);
 
   meta_finalize ();
diff --git a/src/meson.build b/src/meson.build
index 3e6df2f..25632be 100644
--- a/src/meson.build
+++ b/src/meson.build
@@ -18,6 +18,7 @@ mutter_pkg_deps = [
   glib_dep,
   gsettings_desktop_schemas_dep,
   gtk3_dep,
+  libcapng_dep,
   pango_dep,
 ]
 

base-commit: dbc9cd1dd3e97cc56cde58db73be58840c6164d8
-- 
git-series 0.9.1
